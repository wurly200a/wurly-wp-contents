#+BLOG: wurly-blog
#+POSTID: 1134
#+ORG2BLOG:
#+DATE: [2024-02-18 Sun 14:50]
#+OPTIONS: toc:nil num:nil todo:nil pri:nil tags:nil ^:nil
#+CATEGORY: Kubernetes
#+TAGS: 
#+DESCRIPTION:
#+TITLE: HA Kubernetes クラスターの構築

* はじめに

下記では、ラズパイ3台でコントロールプレーン・ワーカーノードを含めたクラスタを構成するやり方を学びました。

 - [[./?p=1011][おうちKubernetesをはじめる(その1)]]
 - [[./?p=1035][おうちKubernetesをはじめる(その2)]]
 - [[./?p=1055][おうちKubernetesをはじめる(その3)]]

また、下記でHA(High Availability)構成について少し理解を深めました。

 - [[./?p=1090][KubernetesのHA構成(コントロールプレーン、etcd、ワーカー)]]

次のステップとして、ラズパイ3台でコントロールプレーンを構成、ワーカーをamd64のPC1台で構成する、半HA構成に取り組みます。

ワーカー用マシンについては、下記で確保しました。

 - [[./?p=1126][おうちKubernetes amd64 ワーカー用マシンの候補]]
 - [[./?p=1132][ASUS Chromebox 3 に Ubuntu 22.04 をインストール]]

そして実はHA構成に対してはもう一つ構成要素が必要となります。
それはロードバランサー(load balancer:LB)です。

LBをコントロールプレーンを構成するマシンに配置する例もありますが、個人的にはこれはしっくり来ません。
LBが稼働しているマシンが落ちたら終わってしまうのでHA構成の意味がありません。(私の知識が足りないだけで意味があるのかもしれませんが)

よって別のマシンにLBを立てたいと思いますが、できるだけ少電力なものが望ましいです。
OpenWrtのパッケージに haproxy、keepalived が含まれることがわかりましたので、BuffaloのルーターにOpenWrtをインストールし、これを使用します。

 - [[./?p=1260][WZR-1750DHP に OpenWrt をインストール]]

* 全体構成

#+begin_src mermaid :file images/1134_51.png
%%{init:{'theme':'base','flowchart':{'rankSpacing':10}}}%%
graph TB
  subgraph controlplane1[control plane node]
    APISERVER1["apiserver"]
    CONTROLLER1["controller-manager"]
  end
  
  subgraph controlplane2[control plane node]
    APISERVER2["apiserver"]
  end
  
  subgraph controlplane3[control plane node]
    APISERVER3["apiserver"]
  end

  
  LB["load balancer"]
  
  %% relation
  CHROMEBOX3---LB
  LB---APISERVER1
  LB---APISERVER2
  LB---APISERVER3
  APISERVER1---CONTROLLER1
  
  %%style
  classDef SERVER fill:#46d,fill-opacity:100
  class controlplane1 SERVER

#+end_src

#+results:
[[file:images/1134_51.png]]

* ロードバランサー

* 参考
 - [[https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/high-availability/][Creating Highly Available Clusters with kubeadm | Kubernetes]]
 - [[https://www.google.com/search?q=Creating+Highly+Available+Clusters+with+kubeadm&sourceid=chrome&ie=UTF-8][Creating Highly Available Clusters with kubeadm - Google Search]]
 - [[https://medium.com/@heshani.samarasekara/creating-highly-available-kubernetes-cluster-using-kubeadm-31cca3fec76e][Creating Highly Available Kubernetes Cluster using kubeadm | by Heshani Samarasekara | Medium]]
 - [[https://www.unitasglobal.co.jp/english/news/?p=258][Setting up Kubernetes High Availability Cluster – Building and testing a multiple masters Part II – Unitas Global]]
 - [[https://www.unitasglobal.co.jp/english/news/?p=256][Setting up Kubernetes High Availability Cluster – Building and testing a multiple masters Part I – Unitas Global]]
 - [[https://knowledge.sakura.ad.jp/8084/][多機能プロクシサーバー「HAProxy」のさまざまな設定例 | さくらのナレッジ]]
 - [[https://zenn.dev/f110/articles/cab6590c4d4bc8][Managed Kubernetesサービス開発者の自宅k8sクラスタ全容]]
